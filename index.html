// ============================================
// SISTEM PERHITUNGAN HM MESIN PKS
// PT. BANGKITGIAT USAHA MANDIRI
// By. Jonius Abertus
// ============================================

// Data Storage
let machineData = {
    press: { 1: [], 2: [], 3: [], 4: [] },
    digester: { 1: [], 2: [], 3: [], 4: [] },
    sludge: { 3: [], 4: [], 5: [], 6: [], 7: [], 8: [] },
    ripple: { 1: [], 2: [], 3: [] }
};

let spareParts = {
    press: [],
    digester: [],
    sludge: [],
    ripple: []
};

let currentMachine = null;
let currentStatus = 'normal';
let allData = [];

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    console.log('Aplikasi dimulai...');
    loadDataFromStorage();
    initializeApp();
    setTodayDate();
    updateAllDisplays();
});

// Initialize App
function initializeApp() {
    console.log('Inisialisasi aplikasi...');
    loadDataFromStorage();
    updateSummaryTable();
    updateHistoryTable();
    updateSparePartTable();
}

// Set today's date as default
function setTodayDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('operasiDate').value = today;
}

// ============================================
// TAB NAVIGATION
// ============================================

function switchTab(tabName) {
    // Hide all tabs
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Remove active class from all buttons
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked button
    event.target.closest('.tab-btn').classList.add('active');
    
    console.log('Beralih ke tab: ' + tabName);
}

// ============================================
// MACHINE SELECTION
// ============================================

function selectMachine(type, number) {
    currentMachine = { type: type, number: number };
    
    const machineNames = {
        press: 'MESIN PRESS',
        digester: 'DIGESTER',
        sludge: 'SLUDGE CENTRIFUGE',
        ripple: 'RIPPLE MILL'
    };
    
    document.getElementById('selectedMachine').value = 
        machineNames[type] + ' #' + number;
    
    // Highlight selected button
    document.querySelectorAll('.machine-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.closest('.machine-btn').classList.add('active');
    
    console.log('Mesin terpilih: ' + type + ' #' + number);
}

// ============================================
// STATUS SELECTION
// ============================================

function selectStatus(status) {
    currentStatus = status;
    document.querySelectorAll('.status-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    console.log('Status: ' + status);
}

// ============================================
// CALCULATION FUNCTIONS
// ============================================

function hitungHM() {
    if (!currentMachine) {
        alert('Pilih mesin terlebih dahulu!');
        return;
    }
    
    const hmAwal = parseFloat(document.getElementById('hmAwal').value);
    const hmAkhir = parseFloat(document.getElementById('hmAkhir').value);
    
    if (isNaN(hmAwal) || isNaN(hmAkhir)) {
        alert('Masukkan HM Awal dan HM Akhir dengan benar!');
        return;
    }
    
    const selisih = hmAkhir - hmAwal;
    
    if (selisih < 0) {
        alert('HM Akhir harus lebih besar dari HM Awal!');
        return;
    }
    
    // Display results
    document.getElementById('resultSelisih').textContent = selisih.toFixed(2) + ' jam';
    document.getElementById('resultHariIni').textContent = selisih.toFixed(2) + ' jam';
    
    console.log('Perhitungan HM - Selisih: ' + selisih);
}

function hitungSemua() {
    let totalHariIni = 0;
    let totalCumulative = 0;
    let totalMesin = 0;
    
    // Iterate through all machines and calculate
    for (let type in machineData) {
        for (let number in machineData[type]) {
            if (machineData[type][number].length > 0) {
                totalMesin++;
                let machineTotal = 0;
                machineData[type][number].forEach(data => {
                    machineTotal += data.selisih;
                });
                totalCumulative += machineTotal;
                
                // Get today's data
                const today = new Date().toISOString().split('T')[0];
                machineData[type][number].forEach(data => {
                    if (data.tanggal === today) {
                        totalHariIni += data.selisih;
                    }
                });
            }
        }
    }
    
    document.getElementById('totalHariIni').textContent = totalHariIni.toFixed(2);
    document.getElementById('totalCumulative').textContent = totalCumulative.toFixed(2);
    document.getElementById('totalMesin').textContent = totalMesin;
    
    document.getElementById('resultTotal').textContent = totalCumulative.toFixed(2) + ' jam';
    document.getElementById('resultMesin').textContent = totalMesin + ' unit';
    
    console.log('Perhitungan Semua - Total HM: ' + totalCumulative);
}

// ============================================
// DATA MANAGEMENT
// ============================================

function simpanData() {
    if (!currentMachine) {
        alert('Pilih mesin terlebih dahulu!');
        return;
    }
    
    const hmAwal = parseFloat(document.getElementById('hmAwal').value);
    const hmAkhir = parseFloat(document.getElementById('hmAkhir').value);
    const tanggal = document.getElementById('operasiDate').value;
    const keterangan = document.getElementById('hmNotes').value;
    
    if (isNaN(hmAwal) || isNaN(hmAkhir) || !tanggal) {
        alert('Lengkapi semua data terlebih dahulu!');
        return;
    }
    
    const selisih = hmAkhir - hmAwal;
    
    if (selisih < 0) {
        alert('HM Akhir harus lebih besar dari HM Awal!');
        return;
    }
    
    const dataRecord = {
        tanggal: tanggal,
        mesin: currentMachine.type,
        unit: currentMachine.number,
        hmAwal: hmAwal,
        hmAkhir: hmAkhir,
        selisih: selisih,
        status: currentStatus,
        keterangan: keterangan,
        timestamp: new Date().getTime()
    };
    
    // Add to machine data
    machineData[currentMachine.type][currentMachine.number].push(dataRecord);
    
    // Add to all data for history
    allData.push(dataRecord);
    
    // Save to local storage
    saveDataToStorage();
    
    // Update displays
    updateAllDisplays();
    
    // Show success message
    alert('Data berhasil disimpan!');
    
    // Reset form
    resetForm();
    
    console.log('Data disimpan:', dataRecord);
}

function resetForm() {
    document.getElementById('hmAwal').value = '';
    document.getElementById('hmAkhir').value = '';
    document.getElementById('hmNotes').value = '';
    document.getElementById('resultSelisih').textContent = '0.00 jam';
    document.getElementById('resultHariIni').textContent = '0.00 jam';
    document.getElementById('resultTotal').textContent = '0.00 jam';
    document.getElementById('resultMesin').textContent = '0 unit';
    setTodayDate();
    currentMachine = null;
    currentStatus = 'normal';
    document.getElementById('selectedMachine').value = 'Pilih mesin terlebih dahulu';
    document.querySelectorAll('.machine-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.status-btn.normal').classList.add('active');
    console.log('Form direset');
}

// ============================================
// DISPLAY UPDATES
// ============================================

function updateAllDisplays() {
    updateSummaryTable();
    updateHistoryTable();
    updateSparePartTable();
    hitungSemua();
}

function updateSummaryTable() {
    const tbody = document.querySelector('#summaryTable tbody');
    tbody.innerHTML = '';
    
    let no = 1;
    let totalMesin = 0;
    
    for (let type in machineData) {
        for (let number in machineData[type]) {
            const data = machineData[type][number];
            if (data.length > 0) {
                totalMesin++;
                const latestData = data[data.length - 1];
                const totalHM = data.reduce((sum, item) => sum + item.selisih, 0);
                
                const typeNames = {
                    press: 'MESIN PRESS',
                    digester: 'DIGESTER',
                    sludge: 'SLUDGE CENTRIFUGE',
                    ripple: 'RIPPLE MILL'
                };
                
                const statusClass = latestData.status === 'danger' ? 'danger' : 
                                   latestData.status === 'warning' ? 'warning' : 'normal';
                
                const row = `
                    <tr>
                        <td>${no}</td>
                        <td>${typeNames[type]}</td>
                        <td>#${number}</td>
                        <td>${latestData.hmAkhir.toFixed(2)}</td>
                        <td>${totalHM.toFixed(2)}</td>
                        <td><span class="status-badge ${statusClass}">${latestData.status.toUpperCase()}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
                no++;
            }
        }
    }
    
    document.getElementById('totalMesinBadge').textContent = 
        'ðŸ“Š ' + totalMesin + ' Mesin';
}

function updateHistoryTable() {
    const tbody = document.querySelector('#historyTable tbody');
    tbody.innerHTML = '';
    
    // Sort by tanggal descending
    const sortedData = [...allData].sort((a, b) => 
        new Date(b.tanggal) - new Date(a.tanggal)
    );
    
    sortedData.forEach((data, index) => {
        const typeNames = {
            press: 'MESIN PRESS',
            digester: 'DIGESTER',
            sludge: 'SLUDGE CENTRIFUGE',
            ripple: 'RIPPLE MILL'
        };
        
        const statusClass = data.status === 'danger' ? 'danger' : 
                           data.status === 'warning' ? 'warning' : 'normal';
        
        const row = `
            <tr>
                <td>${data.tanggal}</td>
                <td>${typeNames[data.mesin]} #${data.unit}</td>
                <td>${data.hmAwal.toFixed(2)}</td>
                <td>${data.hmAkhir.toFixed(2)}</td>
                <td>${data.selisih.toFixed(2)}</td>
                <td>${data.selisih.toFixed(2)}</td>
                <td><span class="status-badge ${statusClass}">${data.status.toUpperCase()}</span></td>
                <td>${data.keterangan || '-'}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteHistory(${index})">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function deleteHistory(index) {
    if (confirm('Yakin ingin menghapus data ini?')) {
        allData.splice(index, 1);
        saveDataToStorage();
        updateHistoryTable();
        console.log('Data dihapus');
    }
}

function filterHistory() {
    const filterMachine = document.getElementById('filterMachine').value;
    const filterDate = document.getElementById('filterDate').value;
    
    let filtered = allData;
    
    if (filterMachine !== 'all') {
        filtered = filtered.filter(data => data.mesin === filterMachine);
    }
    
    if (filterDate) {
        filtered = filtered.filter(data => data.tanggal === filterDate);
    }
    
    const tbody = document.querySelector('#historyTable tbody');
    tbody.innerHTML = '';
    
    filtered.forEach((data, index) => {
        const typeNames = {
            press: 'MESIN PRESS',
            digester: 'DIGESTER',
            sludge: 'SLUDGE CENTRIFUGE',
            ripple: 'RIPPLE MILL'
        };
        
        const statusClass = data.status === 'danger' ? 'danger' : 
                           data.status === 'warning' ? 'warning' : 'normal';
        
        const row = `
            <tr>
                <td>${data.tanggal}</td>
                <td>${typeNames[data.mesin]} #${data.unit}</td>
                <td>${data.hmAwal.toFixed(2)}</td>
                <td>${data.hmAkhir.toFixed(2)}</td>
                <td>${data.selisih.toFixed(2)}</td>
                <td>${data.selisih.toFixed(2)}</td>
                <td><span class="status-badge ${statusClass}">${data.status.toUpperCase()}</span></td>
                <td>${data.keterangan || '-'}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteHistory(${index})">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
    
    console.log('History difilter');
}

// ============================================
// SPARE PARTS MANAGEMENT
// ============================================

function openAddSparePartModal() {
    document.getElementById('modalTitle').textContent = 'TAMBAH SPARE PART';
    document.getElementById('editMachineType').value = 'press';
    document.getElementById('editPartName').value = '';
    document.getElementById('editLifetime').value = '';
    document.getElementById('editUsed').value = '';
    document.getElementById('editIndex').value = '';
    document.getElementById('sparePartModal').style.display = 'block';
}

function closeSparePartModal() {
    document.getElementById('sparePartModal').style.display = 'none';
}

function saveSparePart() {
    const machineType = document.getElementById('editMachineType').value;
    const partName = document.getElementById('editPartName').value;
    const lifetime = parseFloat(document.getElementById('editLifetime').value);
    const used = parseFloat(document.getElementById('editUsed').value);
    
    if (!partName || isNaN(lifetime) || isNaN(used)) {
        alert('Lengkapi semua data!');
        return;
    }
    
    if (used > lifetime) {
        alert('Terpakai tidak boleh lebih besar dari Lifetime!');
        return;
    }
    
    const part = {
        name: partName,
        lifetime: lifetime,
        used: used,
        remaining: lifetime - used
    };
    
    const index = document.getElementById('editIndex').value;
    
    if (index === '') {
        spareParts[machineType].push(part);
    } else {
        spareParts[machineType][parseInt(index)] = part;
    }
    
    saveDataToStorage();
    updateSparePartTable();
    closeSparePartModal();
    alert('Spare part berhasil disimpan!');
}

function updateSparePartTable() {
    const tbody = document.querySelector('#sparePartTable tbody');
    tbody.innerHTML = '';
    
    let no = 1;
    const typeNames = {
        press: 'MESIN PRESS',
        digester: 'DIGESTER',
        sludge: 'SLUDGE CENTRIFUGE',
        ripple: 'RIPPLE MILL'
    };
    
    for (let type in spareParts) {
        spareParts[type].forEach((part, index) => {
            const status = part.remaining <= 0 ? 'CRITICAL' : 
                          part.remaining <= part.lifetime * 0.2 ? 'WARNING' : 'NORMAL';
            const statusClass = status === 'CRITICAL' ? 'danger' : 
                               status === 'WARNING' ? 'warning' : 'normal';
            
            const row = `
                <tr>
                    <td>${no}</td>
                    <td>${typeNames[type]}</td>
                    <td>${part.name}</td>
                    <td>${part.lifetime.toFixed(2)}</td>
                    <td>${part.used.toFixed(2)}</td>
                    <td>${part.remaining.toFixed(2)}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>${part.remaining <= 0 ? 'GANTI SEGERA' : 'Baik'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editSparePart('${type}', ${index})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSparePart('${type}', ${index})">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
            no++;
        });
    }
}

function editSparePart(type, index) {
    const part = spareParts[type][index];
    document.getElementById('modalTitle').textContent = 'EDIT SPARE PART';
    document.getElementById('editMachineType').value = type;
    document.getElementById('editPartName').value = part.name;
    document.getElementById('editLifetime').value = part.lifetime;
    document.getElementById('editUsed').value = part.used;
    document.getElementById('editIndex').value = index;
    document.getElementById('editMachineTypeIndex').value = type;
    document.getElementById('sparePartModal').style.display = 'block';
}

function deleteSparePart(type, index) {
    if (confirm('Yakin ingin menghapus spare part ini?')) {
        spareParts[type].splice(index, 1);
        saveDataToStorage();
        updateSparePartTable();
        console.log('Spare part dihapus');
    }
}

// ============================================
// REPORT GENERATION
// ============================================

function previewReport() {
    const period = document.getElementById('reportPeriod').value;
    const asisten = document.getElementById('reportAsisten').value;
    const reportNo = document.getElementById('reportNo').value;
    
    let html = `
        <div style="border: 2px solid #000; padding: 20px; background: white;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 16px; font-weight: bold;">LAPORAN HM MESIN PKS</h2>
                <p style="margin: 5px 0; font-size: 12px;">PT. BANGKITGIAT USAHA MANDIRI</p>
            </div>
            
            <div style="margin-bottom: 15px; font-size: 12px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 20%;">No. Laporan</td>
                        <td style="width: 5%;">:</td>
                        <td>${reportNo}</td>
                    </tr>
                    <tr>
                        <td>Asisten</td>
                        <td>:</td>
                        <td>${asisten}</td>
                    </tr>
                    <tr>
                        <td>Periode</td>
                        <td>:</td>
                        <td>${period}</td>
                    </tr>
                    <tr>
                        <td>Tanggal Cetak</td>
                        <td>:</td>
                        <td>${new Date().toLocaleDateString('id-ID')}</td>
                    </tr>
                </table>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px;">
                <thead>
                    <tr style="border: 1px solid #000;">
                        <th style="border: 1px solid #000; padding: 5px; text-align: center;">TANGGAL</th>
                        <th style="border: 1px solid #000; padding: 5px; text-align: center;">MESIN</th>
                        <th style="border: 1px solid #000; padding: 5px; text-align: center;">HM AWAL</th>
                        <th style="border: 1px solid #000; padding: 5px; text-align: center;">HM AKHIR</th>
                        <th style="border: 1px solid #000; padding: 5px; text-align: center;">SELISIH</th>
                        <th style="border: 1px solid #000; padding: 5px; text-align: center;">STATUS</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    allData.forEach(data => {
        const typeNames = {
            press: 'PRESS',
            digester: 'DIGESTER',
            sludge: 'SLUDGE',
            ripple: 'RIPPLE'
        };
        
        html += `
            <tr style="border: 1px solid #000;">
                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${data.tanggal}</td>
                <td style="border: 1px solid #000; padding: 5px;">${typeNames[data.mesin]} #${data.unit}</td>
                <td style="border: 1px solid #000; padding: 5px; text-align: right;">${data.hmAwal.toFixed(2)}</td>
                <td style="border: 1px solid #000; padding: 5px; text-align: right;">${data.hmAkhir.toFixed(2)}</td>
                <td style="border: 1px solid #000; padding: 5px; text-align: right;">${data.selisih.toFixed(2)}</td>
                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${data.status.toUpperCase()}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
            
            <div style="margin-top: 30px; display: flex; justify-content: space-around; font-size: 11px;">
                <div style="text-align: center;">
                    <p style="margin-bottom: 40px;">Mengetahui,</p>
                    <p style="margin: 0;">Kepala Unit</p>
                </div>
                <div style="text-align: center;">
                    <p style="margin-bottom: 40px;">Operator,</p>
                    <p style="margin: 0;">${asisten}</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('reportPreview').innerHTML = html;
    console.log('Report preview ditampilkan');
}

function generateFDF() {
    alert('Fitur PDF akan diaktifkan dengan library jsPDF. Silakan klik PREVIEW terlebih dahulu.');
    previewReport();
}

function printReport() {
    const preview = document.getElementById('reportPreview');
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(preview.innerHTML);
    printWindow.document.close();
    printWindow.print();
}

function resetReport() {
    document.getElementById('reportAsisten').value = 'Jonius Abertus';
    document.getElementById('reportPeriod').value = 'daily';
    document.getElementById('reportPreview').innerHTML = `
        <div style="text-align: center; padding: 50px; color: #999;">
            <i class="fas fa-file-pdf" style="font-size: 48px; margin-bottom: 20px; display: block;"></i>
            Klik "PREVIEW" untuk melihat laporan
        </div>
    `;
}

// ============================================
// LOCAL STORAGE MANAGEMENT
// ============================================

function saveDataToStorage() {
    localStorage.setItem('machineData', JSON.stringify(machineData));
    localStorage.setItem('spareParts', JSON.stringify(spareParts));
    localStorage.setItem('allData', JSON.stringify(allData));
    console.log('Data disimpan ke localStorage');
}

function loadDataFromStorage() {
    const savedMachineData = localStorage.getItem('machineData');
    const savedSpareParts = localStorage.getItem('spareParts');
    const savedAllData = localStorage.getItem('allData');
    
    if (savedMachineData) {
        machineData = JSON.parse(savedMachineData);
    }
    if (savedSpareParts) {
        spareParts = JSON.parse(savedSpareParts);
    }
    if (savedAllData) {
        allData = JSON.parse(savedAllData);
    }
    
    console.log('Data dimuat dari localStorage');
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function exportData() {
    const dataStr = JSON.stringify({
        machineData: machineData,
        spareParts: spareParts,
        allData: allData
    }, null, 2);
    
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'hm-system-data-' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
    console.log('Data diekspor');
}

function clearAllData() {
    if (confirm('Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) {
        machineData = {
            press: { 1: [], 2: [], 3: [], 4: [] },
            digester: { 1: [], 2: [], 3: [], 4: [] },
            sludge: { 3: [], 4: [], 5: [], 6: [], 7: [], 8: [] },
            ripple: { 1: [], 2: [], 3: [] }
        };
        spareParts = {
            press: [],
            digester: [],
            sludge: [],
            ripple: []
        };
        allData = [];
        localStorage.clear();
        updateAllDisplays();
        alert('Semua data telah dihapus!');
        console.log('Semua data dihapus');
    }
}

console.log('Main.js loaded successfully!');
