<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>HM PMKS – FINAL</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
--blue:#0d47a1;--blue2:#1565c0;
--bg:#f4f6f8;--card:#fff;
--n:#2e7d32;--w:#f9a825;--d:#c62828;
}
*{box-sizing:border-box}
body{margin:0;font-family:Poppins;background:var(--bg)}
header{background:var(--blue);color:#fff;padding:14px;text-align:center}
nav{display:flex;background:#fff}
nav button{flex:1;padding:12px;border:none;background:#fff;font-weight:600}
nav button.active{background:var(--blue2);color:#fff}
.container{padding:14px}
.card{background:var(--card);padding:14px;border-radius:6px;margin-bottom:14px}
input,select,button{width:100%;padding:8px;margin:6px 0}
button.primary{background:var(--blue);color:#fff;border:none}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.status-n{color:var(--n);font-weight:700}
.status-w{color:var(--w);font-weight:700}
.status-d{color:var(--d);font-weight:700}
.hidden{display:none}
</style>
</head>

<body>
<header>
<h2>SISTEM HM PMKS – FINAL</h2>
<small>Offline • Audit-Safe • Industrial</small>
</header>

<nav>
<button class="active" onclick="tab('dash')">Dashboard</button>
<button onclick="tab('hm')">Input HM</button>
<button onclick="tab('his')">Riwayat</button>
<button onclick="tab('sp')">Spare Part</button>
<button onclick="tab('rep')">Laporan</button>
</nav>

<div class="container">

<div id="dash" class="card"></div>
<div id="hm" class="card hidden"></div>
<div id="his" class="card hidden"></div>
<div id="sp" class="card hidden"></div>
<div id="rep" class="card hidden"></div>

</div>

<script>
/* ================= MASTER DATA ================= */
const MESIN=[
"Press No. 1","Press No. 2","Press No. 3","Press No. 4",
"Digester No. 1","Digester No. 2","Digester No. 3","Digester No. 4",
"Sludge Centrifuge No. 3","Sludge Centrifuge No. 4","Sludge Centrifuge No. 5",
"Sludge Centrifuge No. 6","Sludge Centrifuge No. 7","Sludge Centrifuge No. 8",
"Ripple Mill No. 1","Ripple Mill No. 2","Ripple Mill No. 3"
];

let hm=JSON.parse(localStorage.getItem("HM"))||{};
let his=JSON.parse(localStorage.getItem("HIS"))||[];
let sp=JSON.parse(localStorage.getItem("SP"))||[];

/* init hm */
MESIN.forEach(m=>{ if(!hm[m]) hm[m]={awal:0,total:0} });

/* ================= TAB ================= */
function tab(id){
document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
document.getElementById(id).classList.remove('hidden');
document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
event.target.classList.add('active');
render();
}
<script>
/* ================= DASHBOARD ================= */
function renderDashboard(){
let totalHari=0, critical=0;
let html=`<h3>Dashboard</h3><table>
<tr><th>Mesin</th><th>Total HM</th><th>Status</th></tr>`;

MESIN.forEach(m=>{
    let total=hm[m].total||0;
    let status="NORMAL";
    sp.filter(s=>s.mesin===m).forEach(s=>{
        let p=(s.terpakai/s.lifetime)*100;
        if(p>=90){status="CRITICAL";critical++;}
        else if(p>=75 && status!=="CRITICAL") status="WARNING";
    });
    html+=`<tr>
    <td>${m}</td>
    <td>${total.toFixed(2)}</td>
    <td class="status-${status=="NORMAL"?"n":status=="WARNING"?"w":"d"}">${status}</td>
    </tr>`;
});
html+=`</table>`;
if(critical>0){
    alert("⚠️ PERINGATAN: Ada spare part CRITICAL!");
}
dash.innerHTML=html;
}

/* ================= INPUT HM ================= */
function renderHM(){
let opt=MESIN.map(m=>`<option>${m}</option>`).join("");
hm.innerHTML=`
<h3>Input HM Mesin</h3>
<select id="mesinHM">${opt}</select>

<label>HM Awal</label>
<input id="hmAwal" type="number" step="0.01">

<label>HM Akhir</label>
<input id="hmAkhir" type="number" step="0.01">

<label>HM Hari Ini</label>
<input id="hmHari" type="number" step="0.01">

<button class="primary" onclick="simpanHM()">Simpan HM</button>

<hr>
<h4>Spare Part Mesin</h4>
<table>
<tr><th>Spare</th><th>Life</th><th>Terpakai</th><th>Sisa</th><th>Status</th></tr>
<tbody id="spareHM"></tbody>
</table>
`;

mesinHM.onchange=loadHM;
hmAwal.oninput=autoHitung;
hmAkhir.oninput=autoHitung;
loadHM();
}

function loadHM(){
let m=mesinHM.value;
hmAwal.value=hm[m].awal.toFixed(2);
hmAkhir.value="";
hmHari.value="";
renderSpareHM();
}

function autoHitung(){
if(hmAwal.value && hmAkhir.value){
    hmHari.value=(hmAkhir.value-hmAwal.value).toFixed(2);
}
}

/* ================= SIMPAN HM (LOCKED) ================= */
function simpanHM(){
let m=mesinHM.value;
let awal=+hmAwal.value;
let akhir=+hmAkhir.value;
let hari=+hmHari.value;

if(isNaN(awal)||isNaN(akhir)||isNaN(hari)) return alert("Data HM tidak valid");
if(!confirm("Simpan HM? Data tidak bisa diubah.")) return;

/* lock record */
his.push({
tgl:new Date().toLocaleDateString(),
mesin:m,awal,akhir,hari,locked:true
});

/* update hm */
hm[m].awal=akhir;
hm[m].total=(hm[m].total||0)+hari;

/* sinkron spare part */
sp.forEach(s=>{
if(s.mesin===m) s.terpakai+=hari;
});

saveAll();
render();
}

/* ================= SPARE PART ================= */
function renderSpareHM(){
let m=mesinHM.value;
spareHM.innerHTML="";
sp.filter(s=>s.mesin===m).forEach(s=>{
let sisa=s.lifetime-s.terpakai;
let p=(s.terpakai/s.lifetime)*100;
let st=p>=90?"CRITICAL":p>=75?"WARNING":"NORMAL";
spareHM.innerHTML+=`
<tr>
<td>${s.nama}</td>
<td>${s.lifetime}</td>
<td>${s.terpakai.toFixed(2)}</td>
<td>${sisa.toFixed(2)}</td>
<td class="status-${st=="NORMAL"?"n":st=="WARNING"?"w":"d"}">${st}</td>
</tr>`;
});
}

/* ================= RIWAYAT ================= */
function renderHistory(){
hisDiv.innerHTML="<h3>Riwayat HM</h3><table><tr><th>Tgl</th><th>Mesin</th><th>Awal</th><th>Akhir</th><th>HM</th></tr>"+
his.map(h=>`<tr><td>${h.tgl}</td><td>${h.mesin}</td>
<td>${h.awal}</td><td>${h.akhir}</td><td>${h.hari}</td></tr>`).join("")+"</table>";
}

/* ================= PDF FDF ================= */
function renderReport(){
rep.innerHTML=`<h3>Laporan FDF</h3>
<button class="primary" onclick="pdf()">Generate PDF</button>`;
}

function pdf(){
const {jsPDF}=window.jspdf;
let p=new jsPDF();
p.text("LAPORAN HM PMKS",10,10);
let y=20;
his.forEach(h=>{
p.text(`${h.tgl} | ${h.mesin} | ${h.hari} HM`,10,y);
y+=7;
});
p.text("Tanda Tangan,",10,y+15);
p.save("Laporan_HM_PMKS.pdf");
}

/* ================= BACKUP & EXPORT ================= */
function saveAll(){
localStorage.setItem("HM",JSON.stringify(hm));
localStorage.setItem("HIS",JSON.stringify(his));
localStorage.setItem("SP",JSON.stringify(sp));
}

function exportCSV(){
let csv="Tanggal,Mesin,HM Awal,HM Akhir,HM Hari\n";
his.forEach(h=>{
csv+=`${h.tgl},${h.mesin},${h.awal},${h.akhir},${h.hari}\n`;
});
let a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv]));
a.download="HM_PMKS.csv";
a.click();
}

/* ================= RENDER ================= */
function render(){
renderDashboard();
renderHM();
renderHistory();
renderReport();
}
render();
</script>
<div id="hm" class="card hidden">
<h3>Input HM Mesin</h3>

<select id="mesinHM"></select>

<label>HM Awal</label>
<input type="number" id="hmAwal" step="0.01">

<label>HM Akhir</label>
<input type="number" id="hmAkhir" step="0.01">

<label>HM Hari Ini</label>
<input type="number" id="hmHari" step="0.01">

<button class="primary" onclick="simpanHM()">Simpan HM</button>

<hr>
<h4>Spare Part Mesin</h4>
<table>
<thead>
<tr>
<th>Spare Part</th>
<th>Lifetime</th>
<th>Terpakai</th>
<th>Sisa</th>
<th>Status</th>
</tr>
</thead>
<tbody id="spareHMTable"></tbody>
</table>
</div>
<script>
hmAwal.oninput = autoHitung;
hmAkhir.oninput = autoHitung;

function autoHitung(){
    if(hmAwal.value && hmAkhir.value){
        hmHari.value = (hmAkhir.value - hmAwal.value).toFixed(2);
    }
}
</script>
function simpanHM(){
    let mesin = mesinHM.value;
    let awal = parseFloat(hmAwal.value);
    let akhir = parseFloat(hmAkhir.value);
    let hari  = parseFloat(hmHari.value);

    if(isNaN(awal)||isNaN(akhir)||isNaN(hari)){
        alert("Lengkapi data HM");
        return;
    }

    his.push({
        tgl: new Date().toLocaleDateString(),
        mesin, awal, akhir, hari
    });

    hm[mesin].awal = akhir;
    hm[mesin].total += hari;

    /* SINKRON KE SPARE PART */
    sp.forEach(s=>{
        if(s.mesin === mesin){
            s.terpakai += hari;
        }
    });

    localStorage.setItem("HM",JSON.stringify(hm));
    localStorage.setItem("HIS",JSON.stringify(his));
    localStorage.setItem("SP",JSON.stringify(sp));

    alert("HM berhasil disimpan");
    render();
}
function renderSpareHM(){
    let mesin = mesinHM.value;
    spareHMTable.innerHTML = "";

    sp.filter(s=>s.mesin===mesin).forEach(s=>{
        let sisa = s.lifetime - s.terpakai;
        let p = (s.terpakai / s.lifetime) * 100;
        let st = p>=90?"CRITICAL":p>=75?"WARNING":"NORMAL";

        spareHMTable.innerHTML += `
        <tr>
            <td>${s.nama}</td>
            <td>${s.lifetime}</td>
            <td>${s.terpakai.toFixed(2)}</td>
            <td>${sisa.toFixed(2)}</td>
            <td class="status-${st=='NORMAL'?'n':st=='WARNING'?'w':'d'}">${st}</td>
        </tr>`;
    });
}

mesinHM.onchange = renderSpareHM;
